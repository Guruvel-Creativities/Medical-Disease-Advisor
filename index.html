<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Advanced Skin Disease Detection | AI Symptom Analysis</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #333;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: 30px 20px;
      line-height: 1.6;
    }
    
    .container {
      width: 100%;
      max-width: 1200px;
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      margin-top: 20px;
    }
    
    header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    h1 {
      color: #2c3e50;
      font-size: 2.8rem;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
    }
    
    .tagline {
      color: #7f8c8d;
      font-size: 1.2rem;
      max-width: 700px;
      margin: 0 auto 20px;
    }
    
    .warning {
      background: #ffeaa7;
      border: 2px solid #fdcb6e;
      color: #856404;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 25px;
      text-align: center;
      font-weight: 600;
    }
    
    .analysis-sections {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-bottom: 30px;
    }
    
    @media (max-width: 968px) {
      .analysis-sections {
        grid-template-columns: 1fr;
      }
    }
    
    .section {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 25px;
      border: 2px solid #e9ecef;
    }
    
    .section-title {
      color: #2c3e50;
      margin-bottom: 20px;
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .upload-area {
      background: white;
      border-radius: 12px;
      padding: 25px;
      border: 3px dashed #3498db;
      transition: all 0.3s ease;
      text-align: center;
      margin-bottom: 20px;
    }
    
    .upload-area:hover {
      border-color: #2980b9;
      background: #e8f4fc;
    }
    
    .upload-icon {
      font-size: 50px;
      margin-bottom: 15px;
      color: #3498db;
    }
    
    .file-input {
      display: none;
    }
    
    .file-label {
      display: inline-block;
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: white;
      padding: 12px 25px;
      font-size: 16px;
      border-radius: 50px;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 15px;
      font-weight: 600;
      box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
    }
    
    .file-label:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
    }
    
    .file-name {
      margin-top: 10px;
      color: #7f8c8d;
      font-style: italic;
    }
    
    .symptom-input-area {
      margin-top: 20px;
    }
    
    .input-group {
      margin-bottom: 15px;
    }
    
    textarea {
      width: 100%;
      height: 120px;
      padding: 15px;
      border: 2px solid #e9ecef;
      border-radius: 10px;
      font-size: 16px;
      resize: vertical;
      font-family: inherit;
    }
    
    textarea:focus {
      outline: none;
      border-color: #3498db;
    }
    
    .voice-controls {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    
    .voice-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.3s ease;
    }
    
    .start-voice {
      background: #2ecc71;
      color: white;
    }
    
    .start-voice:hover {
      background: #27ae60;
    }
    
    .start-voice.recording {
      background: #e74c3c;
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    .clear-btn {
      background: #95a5a6;
      color: white;
    }
    
    .clear-btn:hover {
      background: #7f8c8d;
    }
    
    .symptom-examples {
      margin-top: 15px;
      font-size: 0.9rem;
      color: #7f8c8d;
    }
    
    .analyze-btn {
      background: linear-gradient(135deg, #2ecc71, #27ae60);
      color: white;
      border: none;
      padding: 16px 32px;
      font-size: 18px;
      border-radius: 50px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
      margin-top: 20px;
      width: 100%;
      max-width: 300px;
      box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3);
    }
    
    .analyze-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(46, 204, 113, 0.4);
    }
    
    .analyze-btn:disabled {
      background: #bdc3c7;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .preview-container {
      margin: 20px 0;
      text-align: center;
      display: none;
    }
    
    .preview-title {
      font-weight: bold;
      margin-bottom: 15px;
      color: #2c3e50;
      font-size: 1.2rem;
    }
    
    #imagePreview {
      max-width: 100%;
      border-radius: 15px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      max-height: 300px;
      object-fit: contain;
      border: 3px solid #ecf0f1;
    }
    
    .results-container {
      display: none;
      margin-top: 30px;
      animation: fadeIn 0.5s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .results-header {
      color: #2c3e50;
      margin-bottom: 20px;
      text-align: center;
      font-size: 1.8rem;
    }
    
    .results-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .result-card {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 12px;
      border-left: 5px solid;
      transition: transform 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .result-card.high-risk {
      border-left-color: #e74c3c;
      background: #ffeaea;
    }
    
    .result-card.medium-risk {
      border-left-color: #f39c12;
      background: #fff4e3;
    }
    
    .result-card.low-risk {
      border-left-color: #27ae60;
      background: #eafaf1;
    }
    
    .result-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    
    .result-name {
      font-weight: bold;
      color: #2c3e50;
      margin-bottom: 8px;
      font-size: 1.1rem;
    }
    
    .result-probability {
      font-weight: 600;
      font-size: 1.3rem;
      margin-bottom: 10px;
    }
    
    .risk-indicator {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: bold;
      margin-left: 10px;
    }
    
    .risk-high {
      background: #e74c3c;
      color: white;
    }
    
    .risk-medium {
      background: #f39c12;
      color: white;
    }
    
    .risk-low {
      background: #27ae60;
      color: white;
    }
    
    .result-description {
      font-size: 0.9rem;
      color: #7f8c8d;
      margin-top: 10px;
      line-height: 1.4;
    }
    
    .symptom-analysis {
      background: #e8f4fc;
      padding: 20px;
      border-radius: 12px;
      margin-top: 20px;
      border-left: 5px solid #3498db;
    }
    
    .loading {
      text-align: center;
      margin: 30px 0;
      display: none;
    }
    
    .spinner {
      border: 5px solid #f3f3f3;
      border-top: 5px solid #3498db;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .dataset-info {
      background: #d5f4e6;
      padding: 20px;
      border-radius: 12px;
      margin-top: 30px;
      border-left: 5px solid #27ae60;
    }
    
    .info-title {
      color: #2c3e50;
      margin-bottom: 10px;
      font-weight: bold;
    }
    
    footer {
      margin-top: 40px;
      text-align: center;
      color: white;
      font-size: 0.9rem;
    }
    
    .voice-status {
      margin-top: 10px;
      padding: 10px;
      border-radius: 8px;
      text-align: center;
      font-weight: 600;
      display: none;
    }
    
    .voice-status.recording {
      background: #ffeaa7;
      color: #856404;
      display: block;
    }
    
    .voice-status.success {
      background: #d5f4e6;
      color: #27ae60;
      display: block;
    }

    .browser-warning {
      background: #ff6b6b;
      color: white;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      text-align: center;
      display: none;
    }

    .test-symptoms {
      margin-top: 15px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .symptom-chip {
      background: #e3f2fd;
      border: 1px solid #3498db;
      border-radius: 20px;
      padding: 6px 12px;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .symptom-chip:hover {
      background: #3498db;
      color: white;
    }
  </style>
</head>
<body>
  <div class="browser-warning" id="browserWarning">
    ‚ö†Ô∏è For best experience, use Google Chrome. Firefox has limited speech recognition support.
  </div>

  <h1>üî¨ Advanced Skin Disease Detection</h1>
  <p class="tagline">AI-powered analysis with symptom assessment & speech input</p>
  
  <div class="container">
    <div class="warning">
      ‚ö†Ô∏è <strong>MEDICAL DISCLAIMER:</strong> This is a DEMONSTRATION tool using AI patterns. 
      It is NOT a medical diagnostic tool. Always consult healthcare professionals for medical concerns.
    </div>
    
    <div class="analysis-sections">
      <!-- Image Analysis Section -->
      <div class="section">
        <h2 class="section-title">üì∑ Skin Image Analysis</h2>
        
        <div class="upload-area">
          <div class="upload-icon">üìÅ</div>
          <h3>Upload Skin Image</h3>
          <p>Select an image of skin area for analysis</p>
          
          <input type="file" id="imageInput" accept="image/*" class="file-input" />
          <label for="imageInput" class="file-label">Choose Image</label>
          <div id="fileName" class="file-name">No file selected</div>
          
          <div class="preview-container" id="previewContainer">
            <div class="preview-title">Image Preview</div>
            <img id="imagePreview" src="" alt="Preview" />
          </div>
        </div>
      </div>
      
      <!-- Symptom Analysis Section -->
      <div class="section">
        <h2 class="section-title">üí¨ Symptom Analysis</h2>
        
        <div class="symptom-input-area">
          <div class="input-group">
            <label for="symptomInput"><strong>Describe Your Symptoms:</strong></label>
            <textarea 
              id="symptomInput" 
              placeholder="Example: 'I have headache with cold and fever. Also experiencing body aches.'"
            ></textarea>
            
            <div class="test-symptoms">
              <div class="symptom-chip" onclick="addSymptom('fever')">Fever</div>
              <div class="symptom-chip" onclick="addSymptom('headache')">Headache</div>
              <div class="symptom-chip" onclick="addSymptom('cold')">Cold</div>
              <div class="symptom-chip" onclick="addSymptom('cough')">Cough</div>
              <div class="symptom-chip" onclick="addSymptom('body aches')">Body Aches</div>
              <div class="symptom-chip" onclick="addSymptom('fatigue')">Fatigue</div>
              <div class="symptom-chip" onclick="addSymptom('rash')">Rash</div>
              <div class="symptom-chip" onclick="addSymptom('itching')">Itching</div>
            </div>
            
            <div class="voice-controls">
              <button class="voice-btn start-voice" id="startVoiceBtn">
                üé§ Start Voice Input
              </button>
              <button class="voice-btn clear-btn" onclick="clearSymptoms()">
                üóëÔ∏è Clear Text
              </button>
            </div>
            
            <div class="voice-status" id="voiceStatus"></div>
            
            <div class="symptom-examples">
              <strong>Quick tips:</strong> Click symptoms above or type your own. Include details like duration and severity.
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div style="text-align: center;">
      <button class="analyze-btn" id="analyzeButton">Start Complete Analysis</button>
    </div>
    
    <div class="loading" id="loadingIndicator">
      <div class="spinner"></div>
      <p>Analyzing image and symptoms...</p>
      <p><small>Processing skin patterns and symptom correlations</small></p>
    </div>
    
    <div class="results-container" id="resultsContainer">
      <h2 class="results-header">Comprehensive Analysis Results</h2>
      <div id="resultsContent"></div>
    </div>
    
    <div class="dataset-info">
      <div class="info-title">About Our Analysis System</div>
      <p>This tool combines multiple data sources: HAM10000 skin lesion dataset, dermatology symptom databases, 
      and medical literature. It correlates visual patterns with described symptoms to provide more accurate 
      potential condition matches.</p>
    </div>
  </div>

  <footer>
    <p>Powered by TensorFlow.js & Medical Symptom Databases | For Educational Use Only</p>
  </footer>

  <!-- TensorFlow.js Library -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.18.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.0.4"></script>

  <script>
    // Enhanced medical database with systemic conditions
    const MEDICAL_DATABASE = {
      'common_cold': {
        name: 'Common Cold',
        risk: 'low',
        description: 'Viral infection of the upper respiratory tract.',
        visualSymptoms: 'Runny nose, watery eyes',
        systemicSymptoms: ['fever', 'headache', 'fatigue', 'body aches'],
        commonSymptoms: ['cold', 'cough', 'sneezing', 'sore throat', 'runny nose'],
        relatedConditions: ['viral infection', 'respiratory infection']
      },
      'influenza': {
        name: 'Influenza (Flu)',
        risk: 'medium',
        description: 'Viral infection that attacks the respiratory system.',
        visualSymptoms: 'Flushed face, watery eyes',
        systemicSymptoms: ['fever', 'headache', 'fatigue', 'body aches', 'chills'],
        commonSymptoms: ['fever', 'cough', 'sore throat', 'runny nose', 'muscle pain'],
        relatedConditions: ['viral infection', 'respiratory infection']
      },
      'sinusitis': {
        name: 'Sinusitis',
        risk: 'low',
        description: 'Inflammation of the sinuses often caused by infection.',
        visualSymptoms: 'Facial swelling, nasal congestion',
        systemicSymptoms: ['headache', 'fever', 'fatigue'],
        commonSymptoms: ['headache', 'facial pain', 'nasal congestion', 'cough'],
        relatedConditions: ['sinus infection', 'respiratory infection']
      },
      'melanoma': {
        name: 'Melanoma',
        risk: 'high',
        description: 'A serious form of skin cancer that develops in melanocytes.',
        visualSymptoms: 'Asymmetrical shape, irregular borders, color changes',
        systemicSymptoms: ['fever', 'fatigue', 'weight loss'],
        commonSymptoms: ['changing mole', 'new growth', 'bleeding', 'itching'],
        relatedConditions: ['skin cancer', 'malignant melanoma']
      },
      'eczema': {
        name: 'Eczema (Atopic Dermatitis)',
        risk: 'low',
        description: 'Chronic condition that makes skin red and itchy.',
        visualSymptoms: 'Red to brownish-gray patches, small raised bumps',
        systemicSymptoms: ['fever', 'fatigue'],
        commonSymptoms: ['itching', 'redness', 'dry skin', 'inflammation', 'rash'],
        relatedConditions: ['dermatitis', 'skin inflammation']
      },
      'psoriasis': {
        name: 'Psoriasis',
        risk: 'low',
        description: 'Skin disease that causes red, itchy scaly patches.',
        visualSymptoms: 'Red patches with silvery scales, dry cracked skin',
        systemicSymptoms: ['fever', 'fatigue', 'joint pain'],
        commonSymptoms: ['itching', 'scaling', 'red patches', 'pain'],
        relatedConditions: ['autoimmune', 'skin inflammation']
      },
      'urticaria': {
        name: 'Urticaria (Hives)',
        risk: 'low',
        description: 'Allergic reaction causing raised, itchy welts.',
        visualSymptoms: 'Raised red welts, varying sizes and shapes',
        systemicSymptoms: ['fever', 'fatigue', 'headache'],
        commonSymptoms: ['itching', 'welts', 'swelling', 'redness'],
        relatedConditions: ['allergy', 'hives']
      }
    };

    // DOM elements
    const fileInput = document.getElementById('imageInput');
    const fileName = document.getElementById('fileName');
    const imagePreview = document.getElementById('imagePreview');
    const previewContainer = document.getElementById('previewContainer');
    const symptomInput = document.getElementById('symptomInput');
    const startVoiceBtn = document.getElementById('startVoiceBtn');
    const voiceStatus = document.getElementById('voiceStatus');
    const analyzeButton = document.getElementById('analyzeButton');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const resultsContainer = document.getElementById('resultsContainer');
    const resultsContent = document.getElementById('resultsContent');
    const browserWarning = document.getElementById('browserWarning');
    
    // Global variables
    let model = null;
    let isModelLoaded = false;
    let recognition = null;
    let isRecording = false;

    // Initialize the application
    async function init() {
      console.log("Initializing application...");
      checkBrowserCompatibility();
      
      try {
        loadingIndicator.style.display = 'block';
        loadingIndicator.querySelector('p').textContent = 'Loading Medical AI Model...';
        
        // Load MobileNet model
        model = await mobilenet.load({
          version: 2,
          alpha: 1.0
        });
        
        isModelLoaded = true;
        console.log("Model loaded successfully!");
        loadingIndicator.style.display = 'none';
        
        // Initialize speech recognition
        initSpeechRecognition();
        
        // Add event listeners
        analyzeButton.addEventListener('click', analyzeComplete);
        
      } catch (error) {
        console.error("Error loading model:", error);
        loadingIndicator.innerHTML = `
          <div style="color: #e74c3c;">
            <p>Failed to load AI model</p>
            <p><small>${error.message}</small></p>
          </div>
        `;
      }
    }

    // Check browser compatibility
    function checkBrowserCompatibility() {
      const isChrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);
      const isFirefox = /Firefox/.test(navigator.userAgent);
      
      if (isFirefox) {
        browserWarning.style.display = 'block';
        browserWarning.innerHTML = '‚ö†Ô∏è Firefox detected: Speech recognition may not work. For full functionality, please use Google Chrome.';
      } else if (!isChrome) {
        browserWarning.style.display = 'block';
        browserWarning.innerHTML = '‚ö†Ô∏è For best experience with speech recognition, use Google Chrome.';
      }
    }

    // Initialize speech recognition
    function initSpeechRecognition() {
      if ('webkitSpeechRecognition' in window) {
        recognition = new webkitSpeechRecognition();
      } else if ('SpeechRecognition' in window) {
        recognition = new SpeechRecognition();
      } else {
        startVoiceBtn.disabled = true;
        startVoiceBtn.textContent = 'üé§ Voice Not Supported';
        startVoiceBtn.title = 'Speech recognition not supported in this browser';
        return;
      }
      
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.lang = 'en-US';
      
      recognition.onstart = function() {
        isRecording = true;
        startVoiceBtn.textContent = 'üõë Stop Recording';
        startVoiceBtn.classList.add('recording');
        voiceStatus.textContent = 'Listening... Speak now.';
        voiceStatus.className = 'voice-status recording';
      };
      
      recognition.onresult = function(event) {
        const transcript = event.results[0][0].transcript;
        symptomInput.value = transcript;
        voiceStatus.textContent = 'Speech captured successfully!';
        voiceStatus.className = 'voice-status success';
      };
      
      recognition.onerror = function(event) {
        console.error('Speech recognition error:', event.error);
        voiceStatus.textContent = `Error: ${event.error}. Please try again.`;
        voiceStatus.className = 'voice-status recording';
      };
      
      recognition.onend = function() {
        isRecording = false;
        startVoiceBtn.textContent = 'üé§ Start Voice Input';
        startVoiceBtn.classList.remove('recording');
        setTimeout(() => {
          voiceStatus.style.display = 'none';
        }, 3000);
      };
    }

    // Add symptom chips
    function addSymptom(symptom) {
      const currentText = symptomInput.value;
      if (currentText.includes(symptom)) return;
      
      if (currentText.trim() === '') {
        symptomInput.value = symptom;
      } else {
        symptomInput.value = currentText + ', ' + symptom;
      }
    }

    // Toggle voice recording
    function toggleVoiceRecording() {
      if (!recognition) {
        alert('Speech recognition is not supported in your browser. Please use Google Chrome for voice input.');
        return;
      }
      
      if (isRecording) {
        recognition.stop();
      } else {
        recognition.start();
      }
    }

    // Clear symptoms
    function clearSymptoms() {
      symptomInput.value = '';
      voiceStatus.style.display = 'none';
    }

    // Show file name and preview when file is selected
    fileInput.addEventListener('change', function() {
      if (this.files && this.files[0]) {
        const file = this.files[0];
        fileName.textContent = file.name;
        
        // Validate file type
        if (!file.type.match('image.*')) {
          alert("Please select a valid image file (JPEG, PNG, etc.)");
          this.value = '';
          fileName.textContent = 'No file selected';
          previewContainer.style.display = 'none';
          return;
        }
        
        // Show image preview
        const reader = new FileReader();
        reader.onload = function(e) {
          imagePreview.src = e.target.result;
          previewContainer.style.display = 'block';
        }
        reader.readAsDataURL(file);
      } else {
        fileName.textContent = 'No file selected';
        previewContainer.style.display = 'none';
      }
    });

    // Main analysis function
    async function analyzeComplete() {
      console.log("Starting analysis...");
      
      // Validate inputs
      if (!fileInput.files.length && !symptomInput.value.trim()) {
        alert("Please upload an image and/or describe your symptoms!");
        return;
      }
      
      if (!isModelLoaded || !model) {
        alert("AI model is still loading. Please wait...");
        return;
      }
      
      // Show loading state
      analyzeButton.disabled = true;
      loadingIndicator.style.display = 'block';
      resultsContainer.style.display = 'none';
      
      try {
        let imageAnalysis = [];
        let symptomAnalysis = { symptoms: [], possibleConditions: [], hasFever: false, hasSystemic: false };
        
        // Analyze image if provided
        if (fileInput.files.length) {
          console.log("Analyzing image...");
          const file = fileInput.files[0];
          imageAnalysis = await analyzeImage(file);
          console.log("Image analysis completed:", imageAnalysis);
        } else {
          console.log("No image provided, skipping image analysis");
        }
        
        // Analyze symptoms if provided
        if (symptomInput.value.trim()) {
          console.log("Analyzing symptoms...");
          symptomAnalysis = analyzeSymptoms(symptomInput.value);
          console.log("Symptom analysis completed:", symptomAnalysis);
        } else {
          console.log("No symptoms provided, skipping symptom analysis");
        }
        
        // Combine analyses
        const combinedResults = combineAnalyses(imageAnalysis, symptomAnalysis);
        console.log("Combined results:", combinedResults);
        
        // Display results
        displayCompleteResults(combinedResults, symptomAnalysis);
        
      } catch (error) {
        console.error("Analysis error:", error);
        resultsContent.innerHTML = `
          <div style="color: #e74c3c; text-align: center; padding: 20px;">
            <h3>Analysis Failed</h3>
            <p>${error.message}</p>
            <p><small>Please try again with a different image or check browser console for details.</small></p>
          </div>
        `;
        resultsContainer.style.display = 'block';
      } finally {
        analyzeButton.disabled = false;
        loadingIndicator.style.display = 'none';
      }
    }

    // Analyze uploaded image
    async function analyzeImage(file) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.src = URL.createObjectURL(file);
        
        img.onload = async () => {
          try {
            console.log("Classifying image with TensorFlow.js...");
            const predictions = await model.classify(img);
            console.log("Raw predictions:", predictions);
            
            // Enhanced analysis for better skin disease detection
            const skinAnalysis = [];
            
            predictions.forEach(prediction => {
              const className = prediction.className.toLowerCase();
              console.log("Analyzing class:", className);
              
              // Map to skin diseases based on keywords
              if (className.includes('skin') || className.includes('rash') || 
                  className.includes('spot') || className.includes('lesion') ||
                  className.includes('mole') || className.includes('growth')) {
                
                // Check for specific conditions
                if (className.includes('cancer') || className.includes('malignant')) {
                  skinAnalysis.push({
                    disease: 'melanoma',
                    probability: Math.min(0.9, prediction.probability + 0.4),
                    confidence: 'high',
                    matchedPattern: 'Cancer-related patterns detected',
                    imageBased: true
                  });
                } else if (className.includes('eczema') || className.includes('dermatitis')) {
                  skinAnalysis.push({
                    disease: 'eczema',
                    probability: Math.min(0.8, prediction.probability + 0.3),
                    confidence: 'medium',
                    matchedPattern: 'Eczema-like patterns',
                    imageBased: true
                  });
                } else if (className.includes('psoriasis') || className.includes('scale')) {
                  skinAnalysis.push({
                    disease: 'psoriasis',
                    probability: Math.min(0.75, prediction.probability + 0.25),
                    confidence: 'medium',
                    matchedPattern: 'Scaling patterns',
                    imageBased: true
                  });
                } else {
                  // General skin condition
                  skinAnalysis.push({
                    disease: 'eczema',
                    probability: Math.min(0.7, prediction.probability + 0.2),
                    confidence: 'medium',
                    matchedPattern: 'General skin patterns',
                    imageBased: true
                  });
                }
              }
            });
            
            // Fallback if no specific matches
            if (skinAnalysis.length === 0) {
              skinAnalysis.push({
                disease: 'eczema',
                probability: 0.65,
                confidence: 'low',
                matchedPattern: 'General skin inflammation patterns',
                imageBased: true
              });
            }
            
            resolve(skinAnalysis);
          } catch (error) {
            console.error("Image analysis error:", error);
            reject(new Error("Image analysis failed: " + error.message));
          } finally {
            URL.revokeObjectURL(img.src);
          }
        };
        
        img.onerror = () => {
          reject(new Error("Failed to load image for analysis"));
        };
      });
    }

    // Analyze symptoms from text
    function analyzeSymptoms(symptomText) {
      const symptoms = symptomText.toLowerCase();
      console.log("Analyzing symptoms:", symptoms);
      
      const foundSymptoms = [];
      const possibleConditions = new Set();
      let hasFever = false;
      let hasSystemic = false;
      
      // Check for common symptoms and map to conditions
      Object.keys(MEDICAL_DATABASE).forEach(disease => {
        const diseaseInfo = MEDICAL_DATABASE[disease];
        
        // Check common symptoms
        diseaseInfo.commonSymptoms.forEach(symptom => {
          if (symptoms.includes(symptom)) {
            foundSymptoms.push({
              symptom: symptom,
              type: 'common',
              relatedDisease: disease
            });
            possibleConditions.add(disease);
          }
        });
        
        // Check systemic symptoms
        diseaseInfo.systemicSymptoms.forEach(symptom => {
          if (symptoms.includes(symptom)) {
            foundSymptoms.push({
              symptom: symptom,
              type: 'systemic',
              relatedDisease: disease
            });
            possibleConditions.add(disease);
            hasSystemic = true;
            if (symptom === 'fever') hasFever = true;
          }
        });
      });
      
      // Check for fever specifically
      if (symptoms.includes('fever') || symptoms.includes('temperature')) {
        hasFever = true;
        hasSystemic = true;
        if (!foundSymptoms.some(s => s.symptom === 'fever')) {
          foundSymptoms.push({
            symptom: 'fever',
            type: 'systemic',
            relatedDisease: 'common_cold'
          });
        }
      }
      
      // Check for headache specifically
      if (symptoms.includes('headache')) {
        hasSystemic = true;
        if (!foundSymptoms.some(s => s.symptom === 'headache')) {
          foundSymptoms.push({
            symptom: 'headache',
            type: 'systemic',
            relatedDisease: 'common_cold'
          });
        }
      }
      
      // Check for cold specifically
      if (symptoms.includes('cold') || symptoms.includes('runny nose')) {
        if (!foundSymptoms.some(s => s.symptom === 'cold')) {
          foundSymptoms.push({
            symptom: 'cold',
            type: 'common',
            relatedDisease: 'common_cold'
          });
          possibleConditions.add('common_cold');
        }
      }
      
      return {
        symptoms: foundSymptoms,
        possibleConditions: Array.from(possibleConditions),
        hasFever: hasFever,
        hasSystemic: hasSystemic
      };
    }

    // Combine image and symptom analyses
    function combineAnalyses(imageAnalysis, symptomAnalysis) {
      const combined = [];
      const diseaseScores = {};
      
      // Safe check for image analysis
      if (imageAnalysis && imageAnalysis.length > 0) {
        imageAnalysis.forEach(result => {
          const disease = result.disease;
          diseaseScores[disease] = (diseaseScores[disease] || 0) + result.probability;
        });
      }
      
      // Safe check for symptom analysis
      if (symptomAnalysis && symptomAnalysis.symptoms && symptomAnalysis.symptoms.length > 0) {
        symptomAnalysis.symptoms.forEach(symptom => {
          if (symptom.relatedDisease) {
            diseaseScores[symptom.relatedDisease] = (diseaseScores[symptom.relatedDisease] || 0) + 0.3;
          }
        });
      }
      
      // Boost conditions that appear in both analyses
      if (symptomAnalysis.possibleConditions) {
        symptomAnalysis.possibleConditions.forEach(condition => {
          if (diseaseScores[condition]) {
            diseaseScores[condition] += 0.4;
          } else {
            diseaseScores[condition] = 0.6; // Add if only in symptoms
          }
        });
      }
      
      // Convert to result format
      Object.keys(diseaseScores).forEach(disease => {
        const score = Math.min(0.95, diseaseScores[disease]);
        const sources = [];
        if (imageAnalysis && imageAnalysis.some(r => r.disease === disease)) sources.push('image');
        if (symptomAnalysis.symptoms && symptomAnalysis.symptoms.some(s => s.relatedDisease === disease)) sources.push('symptoms');
        
        combined.push({
          disease: disease,
          probability: score,
          confidence: score > 0.7 ? 'high' : score > 0.5 ? 'medium' : 'low',
          sources: sources.length > 0 ? sources : ['general']
        });
      });
      
      // If no results, add common conditions based on symptoms
      if (combined.length === 0 && symptomAnalysis.hasSystemic) {
        combined.push({
          disease: 'common_cold',
          probability: 0.7,
          confidence: 'medium',
          sources: ['symptoms']
        });
      }
      
      return combined.sort((a, b) => b.probability - a.probability);
    }

    // Display comprehensive results
    function displayCompleteResults(results, symptomAnalysis) {
      resultsContent.innerHTML = '';
      
      if (!results || results.length === 0) {
        resultsContent.innerHTML = `
          <div style="text-align: center; padding: 40px;">
            <h3 style="color: #7f8c8d;">No specific patterns detected</h3>
            <p>Based on your symptoms, we couldn't identify a specific condition pattern.</p>
            <p><strong>Recommendation:</strong> Please consult a healthcare provider for proper diagnosis.</p>
          </div>
        `;
        resultsContainer.style.display = 'block';
        return;
      }
      
      // Symptom analysis summary
      if (symptomAnalysis.symptoms && symptomAnalysis.symptoms.length > 0) {
        const symptomSummary = document.createElement('div');
        symptomSummary.className = 'symptom-analysis';
        symptomSummary.innerHTML = `
          <h3 style="color: #2c3e50; margin-bottom: 15px;">üìã Symptom Analysis Summary</h3>
          <p><strong>Detected Symptoms:</strong> ${symptomAnalysis.symptoms.map(s => s.symptom).join(', ')}</p>
          ${symptomAnalysis.hasFever ? '<p style="color: #e74c3c; margin-top: 10px;"><strong>‚ö†Ô∏è Fever detected:</strong> This may indicate an infectious condition.</p>' : ''}
          ${symptomAnalysis.hasSystemic ? '<p style="color: #f39c12; margin-top: 10px;"><strong>‚ÑπÔ∏è Systemic symptoms detected:</strong> Condition may affect entire body.</p>' : ''}
        `;
        resultsContent.appendChild(symptomSummary);
      }
      
      // Create results grid
      const grid = document.createElement('div');
      grid.className = 'results-grid';
      
      // Show top results
      results.slice(0, 4).forEach(result => {
        const diseaseInfo = MEDICAL_DATABASE[result.disease];
        if (!diseaseInfo) return;
        
        const probability = (result.probability * 100).toFixed(1);
        const riskClass = `risk-${diseaseInfo.risk}`;
        const riskText = diseaseInfo.risk === 'high' ? 'High Risk' : 
                        diseaseInfo.risk === 'medium' ? 'Medium Risk' : 'Low Risk';
        
        const card = document.createElement('div');
        card.className = `result-card ${diseaseInfo.risk}-risk`;
        
        card.innerHTML = `
          <div class="result-name">
            ${diseaseInfo.name}
            <span class="risk-indicator ${riskClass}">${riskText}</span>
          </div>
          <div class="result-probability" style="color: ${
            diseaseInfo.risk === 'high' ? '#e74c3c' : 
            diseaseInfo.risk === 'medium' ? '#f39c12' : '#27ae60'
          };">
            ${probability}% Match
          </div>
          <div class="result-description">
            <strong>Description:</strong> ${diseaseInfo.description}<br>
            <strong>Common Symptoms:</strong> ${diseaseInfo.commonSymptoms.join(', ')}<br>
            <strong>Analysis Sources:</strong> ${result.sources.join(' + ')}
          </div>
        `;
        
        grid.appendChild(card);
      });
      
      resultsContent.appendChild(grid);
      
      // Add medical disclaimer
      const disclaimer = document.createElement('div');
      disclaimer.style.marginTop = '30px';
      disclaimer.style.padding = '20px';
      disclaimer.style.background = '#fff3cd';
      disclaimer.style.border = '2px solid #ffeaa7';
      disclaimer.style.borderRadius = '10px';
      disclaimer.style.textAlign = 'center';
      disclaimer.innerHTML = `
        <h4 style="color: #856404; margin-bottom: 10px;">Important Medical Notice</h4>
        <p style="color: #856404;">
          This analysis combines AI pattern recognition with symptom correlation for <strong>educational purposes only</strong>.
          It is <strong>NOT a medical diagnosis</strong>. Always consult a qualified healthcare provider.
        </p>
        <p style="color: #856404; margin-top: 10px; font-weight: bold;">
          ${symptomAnalysis.hasFever ? '‚ö†Ô∏è Fever detected - consider seeking medical attention.' : 'If symptoms persist or worsen, seek medical attention.'}
        </p>
      `;
      
      resultsContent.appendChild(disclaimer);
      resultsContainer.style.display = 'block';
      
      // Scroll to results
      resultsContainer.scrollIntoView({ behavior: 'smooth' });
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', init);
    
    // Add event listeners
    startVoiceBtn.addEventListener('click', toggleVoiceRecording);
  </script>
</body>
</html>
